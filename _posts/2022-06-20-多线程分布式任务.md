---
layout:     post
title:      压测-多线程分布式压测任务
subtitle:   压测脚本
date:       2022-06-20
author:     Erain
header-img: img/home-bg.jpg
categories: None
catalog: true
tags:
- 压测
---

# 背景描述
**关键字**：
1. 多线程
2. 分布式
3. 多环境

**环境描述**
脚本实现多线程模拟用户，使用户随机分布在4个环境中运行，脚本放置于k8s中运行，有负载均衡，进行压测时起10个pod运行。

**环境**
单pod内存：2g
单节点内存：8g

**场景描述**
单线程代表单用户，用户启动后，初始化各自的角色数据以及所需的环境变量，并在各自的环境执行用例。

# 问题
## 1. 项目编译时间长
描述：当用例多，静态配置的常量过多且频繁变更时，代码编译时间边长，且因为一个常量的修改就要整个项目重新编译。

解决:   
调整项目结构，将常变变量放于配置文件中。
```
- ErainProject
    |- config
        |- config.yaml
    |- behavior
    |- cases
```

## 2. 脚本全局变量多线程覆盖
描述1：要收集所有角色的id(通过locust启动用户时收集)，使用slice和map都是不安全的，当并发时会有数据丢失。

解决：  
1. 加锁，Mutex
2. 直接用sync.map，方便又快乐，缺点是无法直接查询长度，需要遍历才能知道

描述2：只要一个用户执行某些操作。

解决：
1. 变量控制，var oneTime = false。同样会有并发问题
2. sync.Once

## 3. 环境变量在多pod下的覆盖
描述：要创建一个跨服活动，活动在各个环境下都会生效，即只需要创建一次，单pod下没问题，多pod下会执行多次。如果并发操作会导致数据损坏。
解决：  
多pod单从脚本兼容暂时没有什么好的办法，只能依赖外部服务。
![](/img/post/环境变量在多pod下的覆盖.png)

## 4. 单/多pod数据统计
描述：上述收集所有角色的id，在单pod下，map长度和locust用户数一致，但是在多pod下，只能收集当前pod所在用户。
解决：  
单pod当场收集没问题。多pod下，依赖locust，当前pod数据先上传至locust，随后进行同步

## 5. 针对多环境的定时任务
描述：同3
解决：
![](/img/post/针对多环境的定时任务.png)