---
layout:     post
title:      服务测试指标
subtitle:   用于接口自测, 对外的服务自测
date:       2022-09-15
author:     Erain
header-img: img/home-bg.jpg
categories: 测试
catalog: true
tags:
- 测试
---

# 产出

- **测试脚本**:一个使用任意语言编写的可执行脚本, 可以对不同地址进行测试, 测试内容倾向于业务层面, 测试结果需要以报告的形式呈现,需要包括用例行为和测试结果。
- **使用文档**:脚本的使用方式, 注意点等（特殊接口的处理）
- **测试报告**:使用脚本对服务进行一次完整测试, 产出结果；若出现错误, 需要对错误按照[常见错误](2022-09-16-微服务常见报错.md)进行分类

# 测试指标

测试脚本的最终目的是微服务发生故障时, 可以快速定位故障点。而测试脚本对于大多数服务都是稳定、高效的。如果某服务不适合脚本测试或有其他更好的手段可以证实当前服务情况也是允许的。总结一下, 测试指标就是需要回答下面的问题。

> 此时此刻, 你的服务是否正常, 如果异常, 那么故障点在哪？

# 接口测试指标

绝大部分服务都使用接口作为对外提供服务的方式, 所以接口测试是模拟客户端验证服务正确性的最普遍方式。

理论上需要覆盖接口的所有流程分支, 确保在问题发生时, 可以判定接口的哪部分逻辑错误:即通过提高测试覆盖率来减少排查定位问题的时间。

例如:当一个接口出现4个流程分支式, 由于1分支需要发生问题A难以测试, 所以可以只覆盖2、3、4分支的处理流程, 那么当线上出现问题时, 脚本测试正常即可快速确定原因为问题A。

![img](/img/post/服务测试指标例子1.png)

## 接口类型

不同服务的业务场景不同, 所以对外提供的接口也会有很大差异, 抛去业务细节, 对接口可以进行如下区分:

1. **幂等接口**: 对内不执行数据修改（无副作用）, 对外不同时间的相同请求, 得到的结果总时相同的。

例如:会话服务查询当前在线玩家总数, 返回状态正常, 结果在0以上即可。

1. **资源消费接口**: 因部分功能无法实现, 须请求第三方资源, 并造成一定金额的使用开销。

例如:实名认证服务的“认证接口”需要调用第三方身份认证功能, 此功能需收费, 脚本编写完毕后第一次进行全接口测试, 后续可通过脚本的命令选择忽略测试“认证接口”。

1. **副作用接口**: 对数据进行增删改操作的接口, 

例如:会话服务对所有大区均在redis数据库中有对应db。当会话服务需要测试“创建会话”, “删除会话”接口时, 使用一个保留的大区ID进行测试从而隔离对线上数据的影响。

1. **前置需求接口**: 在测试前需要进行一定的前置操作, 否则不能正常执行，包括mock接口

例如:会话服务的"认证接口", 需要前置"创建会话接口"才能进行正常测试。

## 测试方式

**幂等接口**:直接测试, 幂等接口的返回总时相同的, 将响应与预期结果进行对比即可。

```go
// OnlinePeople 查询在线玩家数量
func OnlinePeople(ctx context.Context, logicalRegionId string)(num int, err error) {

}
// 测试req:{"logical_region_id":"1010"}
// 测试res:{"code":0,"info":"","data":{"num":100}}
```

**资源消费接口**:控制测试, 通过配置读取或flag等方式控制是否需要进行消费接口测试, 减少不必要的资源消费。

```go
// IdentityAuth 身份认证
func IdentityAuth(ctx context.Context, name string, id string)(err error) {
// 本接口会调用第三方实名认证接口进行核实
}
// 测试req:{"name":"张三","id":"12345678901234567X"}
// 测试res:{"code":0,"info":""}
```

**副作用接口**:隔离测试, 将增删改操作与线上数据进行"表隔离"、"库隔离"。若确实无法实现可以跳过此类测试。

```go
// CreateToken 创建会话凭据
func CreateToken(ctx context.Context, logicalRegionId string, id string)(token string, err error) {
// 999999 是业务无法使用的保留id,对应的数据库与线上隔离
}
// 测试req:{"logical_region_id":"999999","id":"ux3fje8nxa"}
// 测试res:{"code":0,"info":"","data":{"token":"abcdefghigklmn"}}
```

**前置需求接口**:组合测试, 为满足接口的前置需求, 需要将多个流程或接口组合到一个测试流程上, 此类接口一般也是有副作用的, 注意数据隔离。

```go
// VityfeToken 验证会话
func VityfeToken(ctx context.Context, token string)(err error) {
// Token需要使用CreateToken接口创建, 所以需要将两个接口组合起来测试
}
// 测试req:{"token":"abcdefghigklmn"}
// 测试res:{"code":0,"info":""}
```

## 测试报告

经过脚本测试后, 需要将测试结果生成/整理成一份规范的测试报告。