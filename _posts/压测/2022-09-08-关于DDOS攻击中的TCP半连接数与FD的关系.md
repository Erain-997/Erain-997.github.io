---
layout:     post
title:      关于DDOS攻击中TCP半连接数与FD的关系
subtitle:   DDOS、TCP
date:       2022-09-08
author:     Erain
header-img: img/home-bg.jpg
categories: 压测
catalog: true
tags:
  - 分布式
  - TCP
---


# 几个概念

1. **什么是Dos**
   > Denial of Service,拒绝服务
1. 什么是DDOS
   > Distributed Denial of Service,分布式拒绝服务
1. TCP的最大连接数
1. 文件描述符FD
   > 文件描述符在形式上是一个非负整数。实际上, 它是一个索引值, 指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时, 内核向进程返回一个文件描述符。

# **client最大tcp连接数**

client每次发起tcp连接请求时, 除非绑定端口, 通常会让系统选取一个空闲的本地端口（local port）, 该端口是独占的, 不能和其他tcp连接共享。tcp端口的数据类型是unsigned short, 因此本地端口个数最大只有65536, 端口0有特殊含义, 不能使用, 这样可用端口最多只有65535, 所以在全部作为client端的情况下, 最大tcp连接数为65535, 这些连接可以连到不同的server ip。

[修改win服务器最大tcp连接数](https://www.jianshu.com/p/00136a97d2d8)

# server最大tcp连接数

server通常固定在某个本地端口上监听, 等待client的连接请求。不考虑地址重用（unix的SO_REUSEADDR选项）的情况下, 即使server端有多个ip, 本地监听端口也是独占的, 因此server端tcp连接4元组中只有remote ip（也就是client ip）和remote port（客户端port）是可变的, 因此最大tcp连接为客户端ip数×客户端port数, 对IPV4, 不考虑ip地址分类等因素, 最大tcp连接数约为2的32次方（ip数）×2的16次方（port数）, 也就是server端单机最大tcp连接数约为2的48次方。

**实际的tcp连接数**

上面给出的是理论上的单机最大连接数, 在实际环境中, 受到机器资源、操作系统等的限制, 特别是sever端, 其最大并发tcp连接数远不能达到理论上限。在unix/linux下限制连接数的主要因素是内存和允许的文件描述符个数（每个tcp连接都要占用一定内存, 每个socket就是一个文件描述符）, 另外1024以下的端口通常为保留端口。在默认2.6内核配置下, 经过试验, 每个socket占用内存在15~20k之间。

影响一个socket占用内存的参数包括：

> - rmem_max
> - wmem_max
> - tcp_rmem
> - tcp_wmem
> - tcp_mem
> - grep skbuff /proc/slabinfo

对server端, 通过增加内存、修改最大文件描述符个数等参数, 单机最大并发TCP连接数超过10万 是没问题的, 国外 Urban Airship 公司在产品环境中已做到 50 万并发 。在实际应用中, 对大规模网络应用, 还需要考虑C10K 问题。

# DDOS攻击

DDoS 就是利用大量合法的分布式服务器向目标发送请求, 从而导致正常合法用户无法获得服务。 总体可以分成两大类：**带宽耗尽型**和 **资源耗尽型**

常见的攻击方式有：

1. **泛洪(TCPSYN)攻击**(目标：网络服务器)     
   发生在第四层, 传输层, TCP握手第一次时
2. **cc攻击**(目标：Web服务器)      
   发生在第七层, 应用层  
   通过代理服务器来生成针对受侵害的主机的合法请求, 实现一种新的操作系统和伪装, 这就是所谓的“CC”。
   CC主要用于攻击网页。如论坛访问时, 如果该论坛较大, 访问者较多, 打开页面的速度会较慢, 访问者越多, 论坛的网页越多, 数据库的压力越大, 访问的频率越高, 系统所占用的资源也就越多。
   > 怎样判断cc攻击是否发生？
   > 1. 普通Web服务器在遭受CC攻击时, 会出现80端口外部关闭的现象, 因为此端口已被大量垃圾数据阻塞, 正常连接已被中断。在命令行中输入命令netstat-an就可以看到了, “SYN_RECEIVED”是一个TCP连接状态标志, 它意味着“正在进行连接的初始同步状态”, 表示无法创建一个正在等待响应。这种攻击的特点就是, 一般这种记录都会有很多条, 代表了不同代理IP的攻击。
   > 1. 记录所有ip连接, 若同一IP与服务器的连接数较多, 则基本上可以断定该IP正对服务器发动CC攻击。
   > 1. 常见的现象就是网站慢、ASP 程序失效、PHP 连接数据库失败、数据库主程序占用 CPU 偏高等。

3. **TCP 全连接攻击**(目标：网络服务器)     
   这种攻击是为了绕过常规防火墙的检查而设计的, 一般情况下, 常规防火墙大多 具备过滤 TearDrop、Land 等 DOS 攻击的能力, 但对于正常的 TCP 连接是放过的, 殊不知很多网络服务程序（如：IIS、Apache 等 Web
   服务器）能接受的 TCP 连接数是有限的, 一旦有大量的 TCP 连接, 即便是正常的, 也会导致网站访问非常缓慢甚至无法访问, TCP 全连接攻击就是通过许多僵尸主机不断地与受害服务器建立大量的 TCP
   连接, 直到服务器的内存等资源被耗尽而被拖跨, 从而造成拒绝服务, 这种攻击的特点是可绕过一般防火墙的防护而达到攻击目的,   
   缺点是需要找很多僵尸主机, 并且由于僵尸主机的 IP 是暴露的, 因此此种 DDOS 攻击方式容易被追踪。

4. **DNS放大攻击**      
   攻击者利用开放DNS解析器的功能产生大量流量, 使目标服务器或网络不堪重负, 导致服务器及其周围基础设施无法访问。     
   所有放大攻击都利用攻击者和目标Web资源之间的带宽消耗差异。当许多请求的成本差异被放大时, 由此产生的巨大流量可以破坏网络基础设施。通过发送导致大型响应的小型查询, 恶意用户可以凭借更少的资源消耗获取更大利益。通过让僵尸网络中的每个机器人提出相似的请求使放大倍增, 攻击者既可以躲避检测, 又会获得攻击流量大幅增加的好处。

5. **SSDP DDoS**       
   简单服务发现协议(SSDP)攻击是一种基于反射的分布式拒绝服务(DDoS)攻击, 它利用通用即插即用(UPnP)网络协议将放大的流量发送给目标受害者, 使目标的基础设施不堪重负并使它们的Web资源脱机。

6. **第三层, 网络层攻击**       
   通过IP将数据包发送到网络目标, 而不使用传输协议。如ping指令     
   由于第3层是无连接的, 因此第3层DDoS攻击无需通过TCP打开连接或指示端口分配。第3层DDoS攻击的目标是计算机正在运行的网络软件, 而不是特定的端口。

7. [扩展](https://blog.csdn.net/zfw_666666/article/details/126222698)

# 针对DDOS攻击中的TCP半连接数

DDOS攻击中, 假如服务器允许的TCP连接数超大, 服务器内存超大, 那么攻击者针对于此种情况往往是发送大量TCP半连接请求, 使得连接数超过FD的最大值或者说FD没有超过最大值, 但是维护FD的内存之和超过服务器内存, 因为FD数对应与连接数, 而大量半连接需要去维护需要大量内存, 使得服务器无法处理。另外, 如果服务器采用select/poll模式进行多路服用, 那为此消耗的CPU资源也同样是可怕的。因此针对于DDOS攻击, 我们要做的就是限制半连接数的数目, 使得它不会影响正常的请求, 同时采用epoll模式进行I/O多路复用。这里简单的介绍一下epoll和select/poll:

epoll是Linux下多路复用IO接口select/poll的增强版本, 它能显著提高程序在大量并发连接中只有少量活跃的情况下的系统CPU利用率, 因为它会复用文件描述符集
合来传递结果而不用迫使开发者每次等待事件之前都必须重新准备要被侦听的文件描述符集合, 另一点原因就是获取事件的时候, 它无须遍历整个被侦听的描述符
集, 只要遍历那些被内核IO事件异步唤醒而加入Ready队列的描述符集合就行了。epoll除了提供select/poll那种IO事件的电平触发 （Level Triggered）外, 还提供了边沿触发（Edge
Triggered）, 这就使得用户空间程序有可能缓存IO状态, 减少epoll_wait/epoll_pwait的调用, 提高应用程序效率.ET只读取一次数据（就算没读完也不在通知, 直到状态改变）, 而LT只要还有数据就会一直通知, 直到读完。